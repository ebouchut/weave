<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>weave â€” Documentation</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <nav>
      <a class="logo" href="index.html">weave</a>
      <div class="links">
        <a href="index.html">Home</a>
        <a href="docs.html" class="active">Docs</a>
        <a href="learn.html">Learn</a>
        <a href="changelog.html">Changelog</a>
        <a href="https://github.com/Ataraxy-Labs/weave">GitHub</a>
      </div>
    </nav>

    <!-- Page header -->
    <div style="padding: 48px 0 16px;">
      <h1 style="font-size: 28px; font-weight: 700; color: var(--accent); letter-spacing: -1px; margin-bottom: 8px;">Documentation</h1>
      <p style="font-size: 14px; color: var(--dim); line-height: 1.7;">Architecture, merge algorithm, CRDT state, MCP tools, and CLI reference.</p>
    </div>

    <!-- TOC -->
    <div style="padding: 20px 0 0; font-size: 13px; color: var(--dim); display: flex; flex-wrap: wrap; gap: 16px;">
      <a href="#how-it-works">How It Works</a>
      <a href="#architecture">Architecture</a>
      <a href="#crdt">CRDT State</a>
      <a href="#mcp">MCP Server</a>
      <a href="#commands">CLI Commands</a>
    </div>

    <!-- How It Works -->
    <section id="how-it-works">
      <h2>How the merge driver works</h2>
      <p class="section-desc">When git encounters a merge, it calls weave-driver with three versions of the file: base, ours, theirs. Here's what happens inside.</p>

      <div class="flow">
        <div class="flow-step">
          <div class="flow-num">1</div>
          <div class="flow-content">
            <div class="title">Parse all three versions</div>
            <div class="desc">tree-sitter extracts entities (functions, classes, methods) from base, ours, and theirs. Each entity gets a stable ID based on its type, name, and parent.</div>
          </div>
        </div>
        <div class="flow-connector"><div class="line"></div></div>
        <div class="flow-step">
          <div class="flow-num">2</div>
          <div class="flow-content">
            <div class="title">Extract regions</div>
            <div class="desc">The file is split into alternating <code style="color:var(--cyan)">Entity</code> and <code style="color:var(--cyan)">Interstitial</code> regions. Interstitials are the whitespace, imports, and syntax between entities.</div>
          </div>
        </div>
        <div class="flow-connector"><div class="line"></div></div>
        <div class="flow-step">
          <div class="flow-num">3</div>
          <div class="flow-content">
            <div class="title">Match entities across versions</div>
            <div class="desc">For each entity in base: did ours change it? Did theirs? Both? Neither? This is where weave understands that two agents editing <em>different</em> functions is not a conflict.</div>
          </div>
        </div>
        <div class="flow-connector"><div class="line"></div></div>
        <div class="flow-step">
          <div class="flow-num">4</div>
          <div class="flow-content">
            <div class="title">Resolve per-entity</div>
            <div class="desc">
              <span style="color:var(--green)">Only ours changed?</span> Use ours.
              <span style="color:var(--green)">Only theirs?</span> Use theirs.
              <span style="color:var(--yellow)">Both changed identically?</span> Use either.
              <span style="color:var(--red)">Both changed differently?</span> Try 3-way merge via <code style="color:var(--cyan)">diffy</code>.
              If that fails on a container (class/impl/trait), try <strong>inner entity merge</strong>: decompose into method-level chunks, match by name, merge each independently.
              Renames are detected via <code style="color:var(--cyan)">structural_hash</code> (AST-normalized).
              Conflicts are classified using the <a href="https://arxiv.org/abs/2409.14121" style="color:var(--cyan)">ConGra taxonomy</a> (Text/Syntax/Functional).
            </div>
          </div>
        </div>
        <div class="flow-connector"><div class="line"></div></div>
        <div class="flow-step">
          <div class="flow-num">5</div>
          <div class="flow-content">
            <div class="title">Reconstruct the file</div>
            <div class="desc">Reassemble the merged file preserving ours-side ordering, with theirs-only additions placed at the correct positions. Write to the ours path per git convention.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Architecture -->
    <section id="architecture">
      <h2>Architecture</h2>
      <p class="section-desc">Five crates in a Cargo workspace. Each can be used independently.</p>

      <div class="arch-layer" style="border-color: var(--green);">
        <div class="label" style="color: var(--green);">weave-core</div>
        <div class="desc">The merge algorithm. Takes three strings (base, ours, theirs) + file path, returns merged content + conflict list. Uses <code style="color:var(--cyan)">sem-core</code> for entity extraction and <code style="color:var(--cyan)">diffy</code> for line-level fallback.</div>
      </div>
      <div class="arch-arrow">&darr;</div>
      <div class="arch-layer" style="border-color: var(--blue);">
        <div class="label" style="color: var(--blue);">weave-driver</div>
        <div class="desc">Git merge driver binary. Git calls it with <code style="color:var(--cyan)">%O %A %B %L %P</code>. Reads three temp files, calls <code style="color:var(--cyan)">entity_merge()</code>, writes result to <code style="color:var(--cyan)">%A</code>. Exit 0 = clean, 1 = conflicts.</div>
      </div>
      <div class="arch-arrow">&darr;</div>
      <div class="arch-layer" style="border-color: var(--purple);">
        <div class="label" style="color: var(--purple);">weave-crdt</div>
        <div class="desc">Automerge-backed entity state. Advisory claims, agent tracking, conflict detection. Persisted at <code style="color:var(--cyan)">.weave/state.automerge</code>. Not committed to git &mdash; local coordination state.</div>
      </div>
      <div class="arch-arrow">&darr;</div>
      <div class="arch-layer" style="border-color: var(--cyan);">
        <div class="label" style="color: var(--cyan);">weave-mcp</div>
        <div class="desc">MCP server with 15 tools. stdio transport for Claude Desktop/CLI integration. Wraps weave-crdt and weave-core into callable agent tools.</div>
      </div>
      <div class="arch-arrow">&darr;</div>
      <div class="arch-layer" style="border-color: var(--orange);">
        <div class="label" style="color: var(--orange);">weave-cli</div>
        <div class="desc">Human-facing CLI. <code style="color:var(--cyan)">weave setup</code>, <code style="color:var(--cyan)">weave preview</code>, <code style="color:var(--cyan)">weave status</code>, <code style="color:var(--cyan)">weave claim</code>, <code style="color:var(--cyan)">weave release</code>.</div>
      </div>
    </section>

    <!-- CRDT -->
    <section id="crdt">
      <h2>CRDT state</h2>
      <p class="section-desc">
        CRDT stands for <strong style="color:var(--accent)">Conflict-free Replicated Data Type</strong> &mdash; a data structure that multiple agents can edit simultaneously without conflicts. Think of it like a Google Doc that always merges correctly.
      </p>

      <div class="concept-box" style="border-color: var(--purple);">
        <h4 style="color: var(--purple);">Why does weave need it?</h4>
        <p>The merge driver is <em>reactive</em> &mdash; it resolves conflicts after they happen. But if two agents are about to edit the same function, you want to know <em>before</em> they collide. The CRDT gives agents a shared "who's editing what" map. Agent A claims <code>processData</code>, Agent B sees the claim and picks a different function instead.</p>
      </div>

      <div class="concept-box" style="border-color: var(--yellow);">
        <h4 style="color: var(--yellow);">Advisory, not enforced</h4>
        <p>Claims are signals, not hard locks. If an agent ignores a claim and edits anyway, the merge still works &mdash; weave's merge driver handles it. This matches the optimistic concurrency model: trust agents to cooperate, handle it gracefully if they don't.</p>
      </div>

      <h3 style="font-size: 16px; color: var(--accent); margin: 32px 0 16px;">Document structure</h3>
      <p style="font-size: 13px; color: var(--dim); margin-bottom: 16px;">
        The state is an <a href="https://automerge.org" style="color:var(--purple)">Automerge</a> document saved to <code style="color:var(--cyan)">.weave/state.automerge</code>. It has three top-level maps:
      </p>

      <div class="state-doc">
<pre><span class="d">{</span>
  <span class="b">"entities"</span>: <span class="d">{</span>                       <span class="d">// every code entity weave knows about</span>
    <span class="c">"src/lib.ts::function::processData"</span>: <span class="d">{</span>
      <span class="b">"name"</span>: <span class="w">"processData"</span>,
      <span class="b">"type"</span>: <span class="w">"function"</span>,
      <span class="b">"file_path"</span>: <span class="w">"src/lib.ts"</span>,
      <span class="b">"content_hash"</span>: <span class="d">"a1b2c3..."</span>,
      <span class="b">"claimed_by"</span>: <span class="g">"agent-1"</span>,          <span class="d">// advisory lock</span>
      <span class="b">"claimed_at"</span>: <span class="y">1706745600000</span>,
      <span class="b">"last_modified_by"</span>: <span class="o">"agent-1"</span>,
      <span class="b">"version"</span>: <span class="y">3</span>
    <span class="d">}</span>
  <span class="d">}</span>,
  <span class="b">"agents"</span>: <span class="d">{</span>                         <span class="d">// registered agents</span>
    <span class="c">"agent-1"</span>: <span class="d">{</span>
      <span class="b">"name"</span>: <span class="w">"agent-1"</span>,
      <span class="b">"status"</span>: <span class="g">"active"</span>,
      <span class="b">"branch"</span>: <span class="w">"feature-auth"</span>,
      <span class="b">"last_seen"</span>: <span class="y">1706745600000</span>,
      <span class="b">"working_on"</span>: [<span class="c">"src/lib.ts::function::processData"</span>]
    <span class="d">}</span>
  <span class="d">}</span>,
  <span class="b">"operations"</span>: [<span class="d">...</span>]               <span class="d">// audit log of claim/release/modify</span>
<span class="d">}</span></pre>
      </div>

      <h3 style="font-size: 16px; color: var(--accent); margin: 32px 0 16px;">Agent coordination flow</h3>
      <div class="flow">
        <div class="flow-step">
          <div class="flow-num" style="border-color:var(--purple);color:var(--purple)">1</div>
          <div class="flow-content">
            <div class="title">Agent registers</div>
            <div class="desc">Calls <code style="color:var(--cyan)">weave_agent_register</code> with its ID and branch. Gets added to the agents map.</div>
          </div>
        </div>
        <div class="flow-connector"><div class="line"></div></div>
        <div class="flow-step">
          <div class="flow-num" style="border-color:var(--purple);color:var(--purple)">2</div>
          <div class="flow-content">
            <div class="title">Agent claims an entity</div>
            <div class="desc">Calls <code style="color:var(--cyan)">weave_claim_entity</code>. Gets back <span class="g">Claimed</span>, <span class="y">AlreadyOwnedBySelf</span>, or <span class="r">AlreadyClaimed { by }</span>.</div>
          </div>
        </div>
        <div class="flow-connector"><div class="line"></div></div>
        <div class="flow-step">
          <div class="flow-num" style="border-color:var(--purple);color:var(--purple)">3</div>
          <div class="flow-content">
            <div class="title">Agent edits the code</div>
            <div class="desc">Periodically calls <code style="color:var(--cyan)">weave_agent_heartbeat</code> with its working_on list. Other agents can check <code style="color:var(--cyan)">weave_who_is_editing</code> before starting work.</div>
          </div>
        </div>
        <div class="flow-connector"><div class="line"></div></div>
        <div class="flow-step">
          <div class="flow-num" style="border-color:var(--purple);color:var(--purple)">4</div>
          <div class="flow-content">
            <div class="title">Agent releases the claim</div>
            <div class="desc">Calls <code style="color:var(--cyan)">weave_release_entity</code> when done. If an agent crashes, <code style="color:var(--cyan)">cleanup_stale_agents</code> releases its claims after a timeout.</div>
          </div>
        </div>
      </div>

      <h3 style="font-size: 16px; color: var(--accent); margin: 32px 0 16px;">Core operations</h3>
      <table>
        <thead>
          <tr><th>Operation</th><th>What it does</th></tr>
        </thead>
        <tbody>
          <tr><td><code style="color:var(--cyan)">claim_entity</code></td><td>Set advisory lock on an entity for an agent</td></tr>
          <tr><td><code style="color:var(--cyan)">release_entity</code></td><td>Remove the lock (only the owner can release)</td></tr>
          <tr><td><code style="color:var(--cyan)">record_modification</code></td><td>Mark that an agent changed an entity, bump version</td></tr>
          <tr><td><code style="color:var(--cyan)">detect_potential_conflicts</code></td><td>Find entities being worked on by multiple agents</td></tr>
          <tr><td><code style="color:var(--cyan)">register_agent</code></td><td>Add an agent to the state with name and branch</td></tr>
          <tr><td><code style="color:var(--cyan)">agent_heartbeat</code></td><td>Keep-alive + update working_on list</td></tr>
          <tr><td><code style="color:var(--cyan)">cleanup_stale_agents</code></td><td>Release claims from agents that stopped heartbeating</td></tr>
          <tr><td><code style="color:var(--cyan)">sync_from_files</code></td><td>Extract entities from working tree files into CRDT state</td></tr>
        </tbody>
      </table>
    </section>

    <!-- MCP Server -->
    <section id="mcp">
      <h2>MCP server</h2>
      <p class="section-desc">
        <a href="https://modelcontextprotocol.io" style="color:var(--cyan)">MCP</a> (Model Context Protocol) lets AI agents call tools. weave-mcp exposes 15 tools over stdio transport. Add it to Claude Code, Claude Desktop, or any MCP-compatible client.
      </p>

      <h3 style="font-size: 16px; color: var(--accent); margin: 0 0 16px;">Setup</h3>

      <div class="terminal">
        <div class="terminal-bar">
          <div class="terminal-dot"></div>
          <div class="terminal-dot"></div>
          <div class="terminal-dot"></div>
          <div class="terminal-title">install</div>
        </div>
        <div class="terminal-body">
<pre><span class="cmd">$ cargo install --git https://github.com/Ataraxy-Labs/weave weave-mcp</span></pre>
        </div>
      </div>

      <div class="terminal">
        <div class="terminal-bar">
          <div class="terminal-dot"></div>
          <div class="terminal-dot"></div>
          <div class="terminal-dot"></div>
          <div class="terminal-title">Claude Code (CLI)</div>
        </div>
        <div class="terminal-body">
<pre><span class="d"># Add to Claude Code (available in all projects)</span>
<span class="cmd">$ claude mcp add --scope user weave -- weave-mcp</span>

<span class="d"># Restart Claude Code, then verify with /mcp</span></pre>
        </div>
      </div>

      <div class="terminal">
        <div class="terminal-bar">
          <div class="terminal-dot"></div>
          <div class="terminal-dot"></div>
          <div class="terminal-dot"></div>
          <div class="terminal-title">Claude Desktop</div>
        </div>
        <div class="terminal-body">
<pre><span class="d"># Add to ~/.config/claude/claude_desktop_config.json</span>
<span class="d">{</span>
  <span class="b">"mcpServers"</span>: <span class="d">{</span>
    <span class="b">"weave"</span>: <span class="d">{</span>
      <span class="b">"command"</span>: <span class="g">"weave-mcp"</span>,
      <span class="b">"args"</span>: []
    <span class="d">}</span>
  <span class="d">}</span>
<span class="d">}</span></pre>
        </div>
      </div>

      <h3 style="font-size: 16px; color: var(--accent); margin: 32px 0 16px;">Tools</h3>

      <div class="tool-grid">
        <div class="tool-card" style="border-color: var(--green);">
          <div class="tool-name">weave_extract_entities</div>
          <div class="tool-desc">List all entities in a file &mdash; names, types, line ranges. Input: <code>{file_path}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--purple);">
          <div class="tool-name">weave_claim_entity</div>
          <div class="tool-desc">Claim an entity before editing. Advisory lock. Input: <code>{agent_id, file_path, entity_name}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--purple);">
          <div class="tool-name">weave_release_entity</div>
          <div class="tool-desc">Release claim after done editing. Input: <code>{agent_id, file_path, entity_name}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--blue);">
          <div class="tool-name">weave_status</div>
          <div class="tool-desc">Entity list with claim and modification status. Input: <code>{file_path}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--blue);">
          <div class="tool-name">weave_who_is_editing</div>
          <div class="tool-desc">Check if anyone is editing a specific entity. Input: <code>{file_path, entity_name}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--red);">
          <div class="tool-name">weave_potential_conflicts</div>
          <div class="tool-desc">Entities being edited by multiple agents. Input: <code>{agent_id?}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--green);">
          <div class="tool-name">weave_preview_merge</div>
          <div class="tool-desc">Dry-run merge analysis between branches. Input: <code>{base_branch, target_branch, file_path?}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--orange);">
          <div class="tool-name">weave_agent_register</div>
          <div class="tool-desc">Register agent in coordination state. Input: <code>{agent_id, branch}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--orange);">
          <div class="tool-name">weave_agent_heartbeat</div>
          <div class="tool-desc">Keep-alive + update working state. Input: <code>{agent_id, working_on}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--yellow);">
          <div class="tool-name">weave_validate_merge</div>
          <div class="tool-desc">Detect semantic risks in a merge &mdash; entities that reference each other and were both modified. Input: <code>{base_branch, target_branch, file_path?}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--cyan);">
          <div class="tool-name">weave_get_dependencies</div>
          <div class="tool-desc">What does this entity call or reference? Uses cross-file dependency graph. Input: <code>{file_path, entity_name}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--cyan);">
          <div class="tool-name">weave_get_dependents</div>
          <div class="tool-desc">Who calls or references this entity? Reverse dependency lookup. Input: <code>{file_path, entity_name}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--cyan);">
          <div class="tool-name">weave_impact_analysis</div>
          <div class="tool-desc">Transitive blast radius if an entity changes. BFS through dependency graph. Input: <code>{file_path, entity_name}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--green);">
          <div class="tool-name">weave_diff</div>
          <div class="tool-desc">Entity-level semantic diff between two refs. Shows added, modified, deleted, renamed entities. Input: <code>{base_ref, target_ref?, file_path?}</code></div>
        </div>
        <div class="tool-card" style="border-color: var(--yellow);">
          <div class="tool-name">weave_merge_summary</div>
          <div class="tool-desc">Parse weave conflict markers into structured JSON. Entity names, conflict types, confidence, resolution hints. Input: <code>{file_path}</code></div>
        </div>
      </div>

      <h3 style="font-size: 16px; color: var(--accent); margin: 32px 0 16px;">Example: agent workflow</h3>
      <div class="terminal">
        <div class="terminal-bar">
          <div class="terminal-dot"></div>
          <div class="terminal-dot"></div>
          <div class="terminal-dot"></div>
          <div class="terminal-title">agent calls via MCP</div>
        </div>
        <div class="terminal-body">
<pre><span class="d">// Agent starts up</span>
<span class="p">weave_agent_register</span>(<span class="d">{</span> <span class="b">agent_id</span>: <span class="g">"claude-1"</span>, <span class="b">branch</span>: <span class="g">"feature-auth"</span> <span class="d">}</span>)

<span class="d">// Check what's in the file</span>
<span class="p">weave_extract_entities</span>(<span class="d">{</span> <span class="b">file_path</span>: <span class="g">"src/auth.ts"</span> <span class="d">}</span>)
<span class="d">// &rarr; [{name: "validateToken", type: "function", ...},</span>
<span class="d">//     {name: "authenticate", type: "function", ...}]</span>

<span class="d">// Claim before editing</span>
<span class="p">weave_claim_entity</span>(<span class="d">{</span> <span class="b">agent_id</span>: <span class="g">"claude-1"</span>, <span class="b">file_path</span>: <span class="g">"src/auth.ts"</span>, <span class="b">entity_name</span>: <span class="g">"validateToken"</span> <span class="d">}</span>)
<span class="d">// &rarr; "Claimed"</span>

<span class="d">// ... agent edits the function ...</span>

<span class="d">// Release when done</span>
<span class="p">weave_release_entity</span>(<span class="d">{</span> <span class="b">agent_id</span>: <span class="g">"claude-1"</span>, <span class="b">file_path</span>: <span class="g">"src/auth.ts"</span>, <span class="b">entity_name</span>: <span class="g">"validateToken"</span> <span class="d">}</span>)
<span class="d">// &rarr; "Released successfully"</span></pre>
        </div>
      </div>
    </section>

    <!-- Commands -->
    <section id="commands">
      <h2>CLI commands</h2>
      <p class="section-desc">The <code style="color:var(--cyan)">weave</code> CLI wraps all functionality for human use.</p>

      <div class="cmd-doc">
        <div class="cmd-doc-header">
          <span class="cmd-doc-name">weave setup</span>
          <span class="cmd-doc-desc">Configure current git repo to use weave as merge driver</span>
        </div>
        <div class="cmd-doc-flags">
          <div class="flag"><code>--driver &lt;path&gt;</code> <span>Path to weave-driver binary (auto-detected if omitted)</span></div>
        </div>
      </div>

      <div class="cmd-doc">
        <div class="cmd-doc-header">
          <span class="cmd-doc-name">weave preview &lt;branch&gt;</span>
          <span class="cmd-doc-desc">Preview what a merge would look like without actually merging</span>
        </div>
        <div class="cmd-doc-flags">
          <div class="flag"><code>--file &lt;path&gt;</code> <span>Preview a specific file only</span></div>
        </div>
      </div>

      <div class="cmd-doc">
        <div class="cmd-doc-header">
          <span class="cmd-doc-name">weave status</span>
          <span class="cmd-doc-desc">Show entity and agent state from CRDT</span>
        </div>
        <div class="cmd-doc-flags">
          <div class="flag"><code>--file &lt;path&gt;</code> <span>Show entities for a specific file</span></div>
          <div class="flag"><code>--agent &lt;id&gt;</code> <span>Show status for a specific agent</span></div>
        </div>
      </div>

      <div class="cmd-doc">
        <div class="cmd-doc-header">
          <span class="cmd-doc-name">weave claim &lt;agent&gt; &lt;file&gt; &lt;entity&gt;</span>
          <span class="cmd-doc-desc">Claim an entity before editing</span>
        </div>
      </div>

      <div class="cmd-doc">
        <div class="cmd-doc-header">
          <span class="cmd-doc-name">weave release &lt;agent&gt; &lt;file&gt; &lt;entity&gt;</span>
          <span class="cmd-doc-desc">Release a previously claimed entity</span>
        </div>
      </div>

      <div class="cmd-doc">
        <div class="cmd-doc-header">
          <span class="cmd-doc-name">weave bench</span>
          <span class="cmd-doc-desc">Run merge benchmarks comparing weave vs git line-level merge</span>
        </div>
      </div>
    </section>

    <footer>
      <p>Built by <a href="https://ataraxy-labs.com">Ataraxy Labs</a></p>
    </footer>
  </div>
</body>
</html>
